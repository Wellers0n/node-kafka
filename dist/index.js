(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};require("dotenv/config");const n=require("express");var t=e.n(n);require("express-async-errors");const r=require("cors");var o=e.n(r);const s=require("swagger-ui-express");var i=e.n(s);const a=require("swagger-jsdoc");var u=e.n(a);const c=(0,n.Router)();c.get("/",((e,n)=>n.status(200).json({message:"Server is fine 🔥"})));const l=require("jsonwebtoken");var d=e.n(l);const v=require("mongoose");var p=e.n(v);const f=new(0,p().Schema)({name:{type:String,required:"name is requerid"},email:{type:String,required:"email is requerid"},password:{type:String,required:"password is requerid"}}),m=p().model("users",f);function h(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}function y(){var e;return e=function*(e){if(!e)return{user:null};try{const n=d().verify(e,"batman");return{user:yield m.findOne({_id:n.id})}}catch(e){return{user:null}}},y=function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){h(s,r,o,i,a,"next",e)}function a(e){h(s,r,o,i,a,"throw",e)}i(void 0)}))},y.apply(this,arguments)}function g(e){return d().sign({id:e._id},"batman")}const w=require("uuid");function P(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const q=function(){var e,n=(e=function*({email:e,password:n}){let t=yield m.findOne({email:e,password:n});return t?{token:g(t._id),message:"Successful login",status:200,clientId:(0,w.v4)()}:{token:null,clientId:null,message:"Invalid credentials˝",status:400}},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){P(s,r,o,i,a,"next",e)}function a(e){P(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}();function _(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const S={getUser:function(e){return y.apply(this,arguments)},generateToken:g,Login:q,Register:function(){var e,n=(e=function*({name:e,email:n,password:t}){return(yield m.findOne({email:n}))?{message:"Error when created an user",status:400}:(yield m.create({name:e,email:n,password:t}),{message:"user created with success",status:201})},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){_(s,r,o,i,a,"next",e)}function a(e){_(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}()};function I(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}function x(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const b={Login:function(){var e,n=(e=function*(e,n){const{email:t,password:r}=e.body;if(!t||!r)return n.status(400).json({message:"Email and password is required"});const{message:o,token:s,status:i,clientId:a}=yield S.Login({email:t,password:r});return n.status(i).json({message:o,token:s,clientId:a})},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){I(s,r,o,i,a,"next",e)}function a(e){I(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e,t){return n.apply(this,arguments)}}(),Register:function(){var e,n=(e=function*(e,n){const{name:t,email:r,password:o}=e.body;if(!t||!r||!o)return n.status(400).json({token:null,message:"Name, email and password is required"});const{message:s,status:i}=yield S.Register({name:t,email:r,password:o});return n.status(i).json({message:s})},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){x(s,r,o,i,a,"next",e)}function a(e){x(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e,t){return n.apply(this,arguments)}}()},j=(0,n.Router)();j.post("/login",b.Login),j.post("/register",b.Register);const k=require("axios");var R=e.n(k);function O(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const E={Search:function(){var e,n=(e=function*({ip:e,timestamp:n,clientId:t}){try{const{data:n}=yield R().get(`${process.env.IPSTACK_URL}/${e}`,{params:{access_key:process.env.IPSTACK_ACCESS_KEY}});return{payload:{ip:n.ip,latitude:n.latitude,longitude:n.longitude,country_name:n.country_name,country_code:n.country_code,region_name:n.region_name,region_code:n.region_code,city:n.city},message:"Successful search",status:200}}catch(e){return{payload:null,status:400,message:"Failed search"}}},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){O(s,r,o,i,a,"next",e)}function a(e){O(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}()},N=require("moment");var T=e.n(N);function A(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const C={Search:function(){var e,n=(e=function*(e,n){const{ip:t,timestamp:r,clientId:o}=e.body;if(console.log({ip:t,timestamp:r,clientId:o}),!t||!r||!o)return n.status(400).json({message:"IP, timestamp and clientId is required"});const{message:s,payload:i,status:a}=yield E.Search({ip:t,timestamp:r,clientId:o}),u=T()().unix();return n.status(a).json({message:s,payload:i,clientId:o,timestamp:u})},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){A(s,r,o,i,a,"next",e)}function a(e){A(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e,t){return n.apply(this,arguments)}}()};function z(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}const L=function(){var e,n=(e=function*(e,n,t){const r=e?.headers?.authorization,o=process.env.JWT_SECRET||"batman";if(!r)return n.status(401).json({message:"Not authorized 🥷!"});d().verify(r,o,((e,r)=>{if(e)return n.status(401).json({message:"Not authorized 🥷!"});t()}))},function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){z(s,r,o,i,a,"next",e)}function a(e){z(s,r,o,i,a,"throw",e)}i(void 0)}))});return function(e,t,r){return n.apply(this,arguments)}}(),K=(0,n.Router)();K.post("/",L,C.Search);const $=(0,n.Router)();$.use("/health",c),$.use("/session",j),$.use("/location",K);const M=JSON.parse('{"definition":{"openapi":"3.0.0","info":{"title":"node-kafka API","version":"1.0.0"},"components":{"securitySchemes":{"token":{"type":"apiKey","in":"header","name":"Authorization"}}}},"apis":["./src/routes/health/*.ts","./src/routes/session/*.ts","./src/routes/location/*.ts"]}'),U=require("dotenv"),D=process.env.MONGO_URI||"mongodb://localhost:27017/node-kafka";function J(e,n,t,r,o,s,i){try{var a=e[s](i),u=a.value}catch(e){return void t(e)}a.done?n(u):Promise.resolve(u).then(r,o)}function W(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var s=e.apply(n,t);function i(e){J(s,r,o,i,a,"next",e)}function a(e){J(s,r,o,i,a,"throw",e)}i(void 0)}))}}const F=process.env.PORT||3001,G=t()();U.config(),G.use(o()()),G.use(t().json({})),G.use(t().urlencoded({extended:!0})),G.use($);const V=u()(M);G.use("/docs",i().serve,i().setup(V,{swaggerOptions:{docExpansions:"none",persistAuthorization:!0}})),G.listen(F,W((function*(){console.log(`We are live on ${F}`),console.log(`Environment: ${process.env.ENVIRONMENT}`);try{yield new Promise(((e,n)=>{p().Promise=global.Promise,p().connection.on("error",(e=>n(e))).on("close",(()=>console.log("Database connection closed."))).once("open",(()=>e(p().connections[0]))),p().connect(D)})),console.log("Database connected with success!")}catch(e){throw console.log("Could not connect to database",{error:e}),e}})))})();